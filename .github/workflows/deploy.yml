name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "stg"
        type: choice
        options:
          - stg
          - prod

env:
  GO_VERSION: "1.24"
  GCP_REGION: us-west1
  IMAGE_NAME: namazu

jobs:
  # ==========================================================================
  # Build and Push Docker Image
  # ==========================================================================
  build-and-push:
    name: Build and Push
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=stg" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/namazu/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================================================
  # Deploy Infrastructure with Pulumi
  # ==========================================================================
  deploy-infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: build-and-push
    defaults:
      run:
        working-directory: infra
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=stg" >> $GITHUB_OUTPUT
          fi

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: infra/go.sum

      - name: Install Pulumi
        uses: pulumi/actions@v5

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Pulumi Up
        uses: pulumi/actions@v5
        with:
          command: up
          stack-name: ${{ steps.env.outputs.environment }}
          work-dir: infra
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

  # ==========================================================================
  # Restart Instance to Pull New Image
  # ==========================================================================
  restart-instance:
    name: Restart Instance
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-infra]
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Set environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=stg" >> $GITHUB_OUTPUT
          fi

      - name: Restart instance to pull new image
        run: |
          INSTANCE_NAME="namazu-${{ steps.env.outputs.environment }}-instance"
          ZONE="${{ env.GCP_REGION }}-b"

          # Stop and start to apply new container
          gcloud compute instances stop $INSTANCE_NAME --zone=$ZONE --quiet || true
          sleep 10
          gcloud compute instances start $INSTANCE_NAME --zone=$ZONE --quiet

          echo "Instance restarted. New container will be pulled on startup."

  # ==========================================================================
  # Health Check
  # ==========================================================================
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: restart-instance
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Set environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=stg" >> $GITHUB_OUTPUT
          fi

      - name: Get instance IP
        id: ip
        run: |
          INSTANCE_NAME="namazu-${{ steps.env.outputs.environment }}-instance"
          ZONE="${{ env.GCP_REGION }}-b"

          # Wait for instance to be running
          for i in {1..30}; do
            STATUS=$(gcloud compute instances describe $INSTANCE_NAME --zone=$ZONE --format='get(status)')
            if [ "$STATUS" = "RUNNING" ]; then
              break
            fi
            echo "Waiting for instance to be running... ($i/30)"
            sleep 10
          done

          IP=$(gcloud compute instances describe $INSTANCE_NAME --zone=$ZONE --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Wait for health check
        run: |
          IP="${{ steps.ip.outputs.ip }}"

          for i in {1..30}; do
            if curl -sf "http://$IP:8080/health" > /dev/null 2>&1; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Waiting for service to be ready... ($i/30)"
            sleep 10
          done

          echo "Health check failed after 5 minutes"
          exit 1
