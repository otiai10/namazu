name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "stg"
        type: choice
        options:
          - stg
          - prod

env:
  GO_VERSION: "1.24"
  GCP_REGION: us-west1
  GCP_PROJECT_ID: namazu-live
  GCP_WIF_PROVIDER: projects/835259465629/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  GCP_SERVICE_ACCOUNT: github-actions@namazu-live.iam.gserviceaccount.com
  IMAGE_NAME: namazu

permissions:
  contents: read
  id-token: write

jobs:
  # ==========================================================================
  # Build and Push Docker Image
  # ==========================================================================
  build-and-push:
    name: Build and Push
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod' && 'production' || 'staging' }}
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            ENV="stg"
          fi
          echo "environment=${ENV}" >> $GITHUB_OUTPUT

          # Per-environment config
          case "$ENV" in
            prod)
              echo "tenant_id=prod-c4rwr" >> $GITHUB_OUTPUT
              echo "firestore_database=namazu-prod" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "tenant_id=stage-lctnv" >> $GITHUB_OUTPUT
              echo "firestore_database=namazu-stg" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/namazu/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            COMMIT_HASH=${{ github.sha }}
            VITE_FIREBASE_API_KEY=${{ vars.VITE_FIREBASE_API_KEY }}
            VITE_FIREBASE_AUTH_DOMAIN=namazu-live.firebaseapp.com
            VITE_FIREBASE_PROJECT_ID=namazu-live
            VITE_FIREBASE_TENANT_ID=${{ steps.env.outputs.tenant_id }}
            VITE_FIRESTORE_DATABASE=${{ steps.env.outputs.firestore_database }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================================================
  # Deploy Infrastructure with Pulumi (disabled)
  # ==========================================================================
  # Infrastructure is managed by Pulumi but doesn't need to run on every deploy.
  # Run manually when infrastructure changes are needed:
  #   cd infra && pulumi up --stack stg
  # Requires: PULUMI_ACCESS_TOKEN, GCP credentials

  # ==========================================================================
  # Restart Instance to Pull New Image
  # ==========================================================================
  restart-instance:
    name: Restart Instance
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Set environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=stg" >> $GITHUB_OUTPUT
          fi

      - name: Restart instance to pull new image
        run: |
          INSTANCE_NAME="namazu-${{ steps.env.outputs.environment }}-instance"
          ZONE="${{ env.GCP_REGION }}-b"

          # Stop and start to apply new container
          gcloud compute instances stop $INSTANCE_NAME --zone=$ZONE --quiet || true
          sleep 10
          gcloud compute instances start $INSTANCE_NAME --zone=$ZONE --quiet

          echo "Instance restarted. New container will be pulled on startup."

  # ==========================================================================
  # Health Check
  # ==========================================================================
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: restart-instance
    steps:
      - name: Set environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=stg" >> $GITHUB_OUTPUT
          fi

      - name: Wait for health check
        run: |
          ENV="${{ steps.env.outputs.environment }}"
          EXPECTED_HASH="${{ github.sha }}"

          if [ "$ENV" = "prod" ]; then
            DOMAIN="namazu.live"
          else
            DOMAIN="${ENV}.namazu.live"
          fi

          echo "Checking https://${DOMAIN}/health"
          echo "Expected hash: ${EXPECTED_HASH}"

          for i in {1..30}; do
            RESPONSE=$(curl -sf "https://${DOMAIN}/health" 2>/dev/null || echo "")
            if [ -n "$RESPONSE" ]; then
              ACTUAL_HASH=$(echo "$RESPONSE" | jq -r '.hash // empty')
              echo "Response: $RESPONSE"

              if [ "$ACTUAL_HASH" = "$EXPECTED_HASH" ]; then
                echo "Health check passed! Deployed version verified."
                exit 0
              elif [ -n "$ACTUAL_HASH" ] && [ "$ACTUAL_HASH" != "unknown" ]; then
                echo "Service is up but running old version (hash: $ACTUAL_HASH)"
              fi
            fi
            echo "Waiting for new version to be ready... ($i/30)"
            sleep 10
          done

          echo "Health check failed: new version not deployed after 5 minutes"
          exit 1
