services:
  # ============================================================
  # Firebase Emulators (Auth + Firestore)
  # ============================================================
  firebase-emulators:
    image: fixl/firebase-emulator-suite:14.15.2
    ports:
      - "4000:4000"   # Emulator UI
      - "8081:8081"   # Firestore (ホスト8081 → コンテナ8081)
      - "9099:9099"   # Auth
    environment:
      FIREBASE_PROJECT_ID: namazu-local
      AUTH: "true"
      FIRESTORE: "true"
    volumes:
      - ./firebase:/firebase
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================================
  # API Server (Go + air ホットリロード)
  # ============================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "9898:9898"
    env_file: .env.compose
    environment:
      NAMAZU_SOURCE_TYPE: p2pquake
      NAMAZU_SOURCE_ENDPOINT: wss://api-realtime-sandbox.p2pquake.net/v2/ws
      NAMAZU_STORE_PROJECT_ID: namazu-local
      NAMAZU_API_ADDR: ":9898"
      NAMAZU_STORE_DATABASE: localdev
      FIRESTORE_EMULATOR_HOST: firebase-emulators:8081
    volumes:
      - .:/app
      - go-mod-cache:/go/pkg/mod
    working_dir: /app
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9898/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      firebase-emulators:
        condition: service_healthy

  # ============================================================
  # Web Dev Server (Vite + pnpm)
  # ============================================================
  web:
    image: node:22-alpine
    ports:
      - "5173:5173"
    env_file: .env.compose
    environment:
      VITE_USE_POLLING: "true"
      VITE_FIRESTORE_EMULATOR_HOST: "localhost:8081"
      VITE_FIRESTORE_DATABASE: localdev
      VITE_FIRESTORE_PROJECT_ID: namazu-local
      VITE_API_PROXY_TARGET: http://api:9898
    volumes:
      - ./web:/app
      - web-node-modules:/app/node_modules
    working_dir: /app
    command: sh -c "corepack enable && pnpm install && pnpm dev --host"
    depends_on:
      api:
        condition: service_healthy

  # ============================================================
  # Startup Info (開発サーバーのアクセス先を表示)
  # ============================================================
  info:
    image: alpine:latest
    depends_on:
      firebase-emulators:
        condition: service_healthy
      api:
        condition: service_healthy
      web:
        condition: service_started
    command: |
      sh -c '
        sleep 8
        echo ""
        echo "========================================================"
        echo "  namazu 開発環境が起動しました"
        echo "========================================================"
        echo ""
        echo "  Front Dev サーバー:    http://localhost:5173"
        echo "  API サーバー:          http://localhost:9898"
        echo "  Firebase Emulator UI:  http://localhost:4000"
        echo ""
        echo "========================================================"
        echo ""
      '

volumes:
  go-mod-cache:
  web-node-modules:
